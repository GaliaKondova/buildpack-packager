#!/usr/bin/env ruby
require 'buildpack/packager'
require 'optparse'
require 'buildpack/manifest_validator'

usage_msg = "Usage:\n  #{File.basename(__FILE__)} online|offline"

unless ARGV.length > 0
  STDOUT.puts usage_msg
  exit 1
end

unless File.exist?('manifest.yml')
  STDERR.puts 'Could not find manifest.yml'
  exit 1
end

validator = Buildpack::ManifestValidator.new('manifest.yml')
unless validator.valid?
  STDERR.puts validator.errors
  exit 1
end

options = {
  root_dir: `pwd`.chomp,
  manifest_path: 'manifest.yml',
  mode: ARGV[0].to_sym
}

OptionParser.new do |opts|
  opts.banner = usage_msg

  opts.on("--use-cache", "Cache depepndencies locally") do |use_cache|
    options[:cache] = use_cache
  end
end.parse!

Buildpack::Packager.package(options)
