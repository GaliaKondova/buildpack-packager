#!/usr/bin/env ruby
require 'buildpack/packager'
require 'optparse'
require 'buildpack/manifest_validator'

supported_modes = %w{cached uncached}

usage_msg = "Usage:\n  #{File.basename(__FILE__)} #{supported_modes.join('|')} --force-download"

if !supported_modes.include?(ARGV[0])
  STDOUT.puts usage_msg
  exit 1
end

options = {
  root_dir: `pwd`.chomp,
  manifest_path: 'manifest.yml',
  mode: ARGV[0].to_sym,
  force_download: false
}

OptionParser.new do |opts|
  opts.banner = usage_msg

  opts.on("--force-download", "Force dependencies to be downloaded from the internet") do
    options[:force_download] = true 
  end

  opts.on("--use-full-manifest", "Use manifest containing full set of dependencies") do
    options[:manifest_path] = '.full.manifest.yml'
  end
end.parse!

manifest_path = options[:manifest_path]
unless File.exist?(manifest_path)
  STDERR.puts "Could not find #{manifest_path}"
  exit 1
end

validator = Buildpack::ManifestValidator.new(manifest_path)
unless validator.valid?
  STDERR.puts validator.errors
  exit 1
end

Buildpack::Packager.package(options)
