#!/usr/bin/env ruby
require 'buildpack/packager'
require 'optparse'
require 'buildpack/manifest_validator'

SUPPORTED_MODES = %w{cached uncached}
USAGE_MSG = "USAGE: #{File.basename(__FILE__)} [options] #{SUPPORTED_MODES.join('|')}"

options = {
  root_dir:      Dir.pwd,
  manifest_path: 'manifest.yml',
  force_download: false
}

optparser = OptionParser.new do |opts|
  opts.banner = USAGE_MSG

  opts.on("--force-download", "Force dependencies to be downloaded from the internet. (default is false)") do
    options[:force_download] = true 
  end

  opts.on("--use-custom-manifest=", "Use a custom manifest, passing the path as an argument.") do |manifest_path|
    options[:manifest_path] = manifest_path
  end
end

optparser.parse!

mode = ARGV[0]
if SUPPORTED_MODES.include?(ARGV[0])
  options[:mode] = mode.to_sym
else
  puts "ERROR: Unknown mode '#{mode}'" if mode
  puts optparser
  exit 1
end

manifest_path = options[:manifest_path]
unless File.exist?(manifest_path)
  STDERR.puts "Could not find #{manifest_path}"
  exit 1
end

validator = Buildpack::ManifestValidator.new(manifest_path)
unless validator.valid?
  STDERR.puts validator.errors
  exit 1
end

Buildpack::Packager.package(options)
